import{j as N,b8 as U,b9 as oe,ba as Y,bb as W,bc as V,bd as me,be as O,b4 as fe,bf as pe,u as ye,az as se,r as l,bg as be,bh as Te,bi as we,bj as ve,bk as xe,aB as M,b7 as Ce,bl as ee,bm as te,bn as ne,bo as Pe}from"./index-BGVyTCu4.js";const Me={male:{text:"Nam",value:1},female:{text:"Nữ",value:2},other:{text:"Khác",value:3},notProvided:{text:"Không cung cấp",value:0}},ae=async(e,n)=>{try{const t=await fetch(`${e}/print_templates/${n}/pages.json?t=${Date.now()}`,{cache:"no-store"}).then(h=>h.json()),i=await Promise.all(t.map(h=>fetch(`${e}/print_templates/${n}/${h}?t=${Date.now()}`,{cache:"no-store"})));return(await Promise.all(i.map(h=>h.text()))).map(h=>{const p=new DOMParser().parseFromString(h,"text/html").querySelector(".a4-page"),P=p.getAttribute("data-page-index"),D=p.id;return p.querySelectorAll("[data-field]").forEach(m=>m.setAttribute("data-page-index",P)),Array.from(p.querySelectorAll('input[type="checkbox"]')).forEach(m=>{m.hasAttribute("data-type")||m.setAttribute("data-type","checkbox"),m.hasAttribute("data-page-index")||m.setAttribute("data-page-index",P),m.hasAttribute("data-page-id")||m.setAttribute("data-page-id",D)}),p.outerHTML}).join(`
`)}catch(t){return console.error("Error loading template content:",t),""}},ie=async e=>await fetch(`${e}/print_templates/base.html`,{cache:"no-cache"}).then(t=>t.text()).catch(t=>(console.log(t),"")),pt=()=>N.jsx(N.Fragment,{children:N.jsx(mt,{})}),L=e=>{const n=e.current;if(!n)return null;const t=n.contentDocument||n.contentWindow?.document;return t||null};function re(e,n){const t=+U(e)-+U(n);return t<0?-1:t>0?1:t}function De(e,n,t){const[i,c]=oe(t?.in,e,n);return i.getFullYear()-c.getFullYear()}function ke(e,n,t){const[i,c]=oe(t?.in,e,n),T=re(i,c),h=Math.abs(De(i,c));i.setFullYear(1584),c.setFullYear(1584);const w=re(i,c)===-T,v=T*(h-+w);return v===0?0:v}const Ee={lessThanXSeconds:{one:"dưới 1 giây",other:"dưới {{count}} giây"},xSeconds:{one:"1 giây",other:"{{count}} giây"},halfAMinute:"nửa phút",lessThanXMinutes:{one:"dưới 1 phút",other:"dưới {{count}} phút"},xMinutes:{one:"1 phút",other:"{{count}} phút"},aboutXHours:{one:"khoảng 1 giờ",other:"khoảng {{count}} giờ"},xHours:{one:"1 giờ",other:"{{count}} giờ"},xDays:{one:"1 ngày",other:"{{count}} ngày"},aboutXWeeks:{one:"khoảng 1 tuần",other:"khoảng {{count}} tuần"},xWeeks:{one:"1 tuần",other:"{{count}} tuần"},aboutXMonths:{one:"khoảng 1 tháng",other:"khoảng {{count}} tháng"},xMonths:{one:"1 tháng",other:"{{count}} tháng"},aboutXYears:{one:"khoảng 1 năm",other:"khoảng {{count}} năm"},xYears:{one:"1 năm",other:"{{count}} năm"},overXYears:{one:"hơn 1 năm",other:"hơn {{count}} năm"},almostXYears:{one:"gần 1 năm",other:"gần {{count}} năm"}},Fe=(e,n,t)=>{let i;const c=Ee[e];return typeof c=="string"?i=c:n===1?i=c.one:i=c.other.replace("{{count}}",String(n)),t?.addSuffix?t.comparison&&t.comparison>0?i+" nữa":i+" trước":i},Ne={full:"EEEE, 'ngày' d MMMM 'năm' y",long:"'ngày' d MMMM 'năm' y",medium:"d MMM 'năm' y",short:"dd/MM/y"},Ie={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},Ae={full:"{{date}} {{time}}",long:"{{date}} {{time}}",medium:"{{date}} {{time}}",short:"{{date}} {{time}}"},Se={date:Y({formats:Ne,defaultWidth:"full"}),time:Y({formats:Ie,defaultWidth:"full"}),dateTime:Y({formats:Ae,defaultWidth:"full"})},_e={lastWeek:"eeee 'tuần trước vào lúc' p",yesterday:"'hôm qua vào lúc' p",today:"'hôm nay vào lúc' p",tomorrow:"'ngày mai vào lúc' p",nextWeek:"eeee 'tới vào lúc' p",other:"P"},He=(e,n,t,i)=>_e[e],We={narrow:["TCN","SCN"],abbreviated:["trước CN","sau CN"],wide:["trước Công Nguyên","sau Công Nguyên"]},Ve={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["Quý 1","Quý 2","Quý 3","Quý 4"]},Le={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["quý I","quý II","quý III","quý IV"]},Oe={narrow:["1","2","3","4","5","6","7","8","9","10","11","12"],abbreviated:["Thg 1","Thg 2","Thg 3","Thg 4","Thg 5","Thg 6","Thg 7","Thg 8","Thg 9","Thg 10","Thg 11","Thg 12"],wide:["Tháng Một","Tháng Hai","Tháng Ba","Tháng Tư","Tháng Năm","Tháng Sáu","Tháng Bảy","Tháng Tám","Tháng Chín","Tháng Mười","Tháng Mười Một","Tháng Mười Hai"]},$e={narrow:["01","02","03","04","05","06","07","08","09","10","11","12"],abbreviated:["thg 1","thg 2","thg 3","thg 4","thg 5","thg 6","thg 7","thg 8","thg 9","thg 10","thg 11","thg 12"],wide:["tháng 01","tháng 02","tháng 03","tháng 04","tháng 05","tháng 06","tháng 07","tháng 08","tháng 09","tháng 10","tháng 11","tháng 12"]},Be={narrow:["CN","T2","T3","T4","T5","T6","T7"],short:["CN","Th 2","Th 3","Th 4","Th 5","Th 6","Th 7"],abbreviated:["CN","Thứ 2","Thứ 3","Thứ 4","Thứ 5","Thứ 6","Thứ 7"],wide:["Chủ Nhật","Thứ Hai","Thứ Ba","Thứ Tư","Thứ Năm","Thứ Sáu","Thứ Bảy"]},qe={narrow:{am:"am",pm:"pm",midnight:"nửa đêm",noon:"tr",morning:"sg",afternoon:"ch",evening:"tối",night:"đêm"},abbreviated:{am:"AM",pm:"PM",midnight:"nửa đêm",noon:"trưa",morning:"sáng",afternoon:"chiều",evening:"tối",night:"đêm"},wide:{am:"SA",pm:"CH",midnight:"nửa đêm",noon:"trưa",morning:"sáng",afternoon:"chiều",evening:"tối",night:"đêm"}},Qe={narrow:{am:"am",pm:"pm",midnight:"nửa đêm",noon:"tr",morning:"sg",afternoon:"ch",evening:"tối",night:"đêm"},abbreviated:{am:"AM",pm:"PM",midnight:"nửa đêm",noon:"trưa",morning:"sáng",afternoon:"chiều",evening:"tối",night:"đêm"},wide:{am:"SA",pm:"CH",midnight:"nửa đêm",noon:"giữa trưa",morning:"vào buổi sáng",afternoon:"vào buổi chiều",evening:"vào buổi tối",night:"vào ban đêm"}},Re=(e,n)=>{const t=Number(e),i=n?.unit;if(i==="quarter")switch(t){case 1:return"I";case 2:return"II";case 3:return"III";case 4:return"IV"}else if(i==="day")switch(t){case 1:return"thứ 2";case 2:return"thứ 3";case 3:return"thứ 4";case 4:return"thứ 5";case 5:return"thứ 6";case 6:return"thứ 7";case 7:return"chủ nhật"}else{if(i==="week")return t===1?"thứ nhất":"thứ "+t;if(i==="dayOfYear")return t===1?"đầu tiên":"thứ "+t}return String(t)},Ye={ordinalNumber:Re,era:W({values:We,defaultWidth:"wide"}),quarter:W({values:Ve,defaultWidth:"wide",formattingValues:Le,defaultFormattingWidth:"wide",argumentCallback:e=>e-1}),month:W({values:Oe,defaultWidth:"wide",formattingValues:$e,defaultFormattingWidth:"wide"}),day:W({values:Be,defaultWidth:"wide"}),dayPeriod:W({values:qe,defaultWidth:"wide",formattingValues:Qe,defaultFormattingWidth:"wide"})},je=/^(\d+)/i,ze=/\d+/i,Xe={narrow:/^(tcn|scn)/i,abbreviated:/^(trước CN|sau CN)/i,wide:/^(trước Công Nguyên|sau Công Nguyên)/i},Ke={any:[/^t/i,/^s/i]},Ge={narrow:/^([1234]|i{1,3}v?)/i,abbreviated:/^q([1234]|i{1,3}v?)/i,wide:/^quý ([1234]|i{1,3}v?)/i},Ze={any:[/(1|i)$/i,/(2|ii)$/i,/(3|iii)$/i,/(4|iv)$/i]},Je={narrow:/^(0?[2-9]|10|11|12|0?1)/i,abbreviated:/^thg[ _]?(0?[1-9](?!\d)|10|11|12)/i,wide:/^tháng ?(Một|Hai|Ba|Tư|Năm|Sáu|Bảy|Tám|Chín|Mười|Mười ?Một|Mười ?Hai|0?[1-9](?!\d)|10|11|12)/i},Ue={narrow:[/0?1$/i,/0?2/i,/3/,/4/,/5/,/6/,/7/,/8/,/9/,/10/,/11/,/12/],abbreviated:[/^thg[ _]?0?1(?!\d)/i,/^thg[ _]?0?2/i,/^thg[ _]?0?3/i,/^thg[ _]?0?4/i,/^thg[ _]?0?5/i,/^thg[ _]?0?6/i,/^thg[ _]?0?7/i,/^thg[ _]?0?8/i,/^thg[ _]?0?9/i,/^thg[ _]?10/i,/^thg[ _]?11/i,/^thg[ _]?12/i],wide:[/^tháng ?(Một|0?1(?!\d))/i,/^tháng ?(Hai|0?2)/i,/^tháng ?(Ba|0?3)/i,/^tháng ?(Tư|0?4)/i,/^tháng ?(Năm|0?5)/i,/^tháng ?(Sáu|0?6)/i,/^tháng ?(Bảy|0?7)/i,/^tháng ?(Tám|0?8)/i,/^tháng ?(Chín|0?9)/i,/^tháng ?(Mười|10)/i,/^tháng ?(Mười ?Một|11)/i,/^tháng ?(Mười ?Hai|12)/i]},et={narrow:/^(CN|T2|T3|T4|T5|T6|T7)/i,short:/^(CN|Th ?2|Th ?3|Th ?4|Th ?5|Th ?6|Th ?7)/i,abbreviated:/^(CN|Th ?2|Th ?3|Th ?4|Th ?5|Th ?6|Th ?7)/i,wide:/^(Chủ ?Nhật|Chúa ?Nhật|thứ ?Hai|thứ ?Ba|thứ ?Tư|thứ ?Năm|thứ ?Sáu|thứ ?Bảy)/i},tt={narrow:[/CN/i,/2/i,/3/i,/4/i,/5/i,/6/i,/7/i],short:[/CN/i,/2/i,/3/i,/4/i,/5/i,/6/i,/7/i],abbreviated:[/CN/i,/2/i,/3/i,/4/i,/5/i,/6/i,/7/i],wide:[/(Chủ|Chúa) ?Nhật/i,/Hai/i,/Ba/i,/Tư/i,/Năm/i,/Sáu/i,/Bảy/i]},nt={narrow:/^(a|p|nửa đêm|trưa|(giờ) (sáng|chiều|tối|đêm))/i,abbreviated:/^(am|pm|nửa đêm|trưa|(giờ) (sáng|chiều|tối|đêm))/i,wide:/^(ch[^i]*|sa|nửa đêm|trưa|(giờ) (sáng|chiều|tối|đêm))/i},at={any:{am:/^(a|sa)/i,pm:/^(p|ch[^i]*)/i,midnight:/nửa đêm/i,noon:/trưa/i,morning:/sáng/i,afternoon:/chiều/i,evening:/tối/i,night:/^đêm/i}},it={ordinalNumber:me({matchPattern:je,parsePattern:ze,valueCallback:e=>parseInt(e,10)}),era:V({matchPatterns:Xe,defaultMatchWidth:"wide",parsePatterns:Ke,defaultParseWidth:"any"}),quarter:V({matchPatterns:Ge,defaultMatchWidth:"wide",parsePatterns:Ze,defaultParseWidth:"any",valueCallback:e=>e+1}),month:V({matchPatterns:Je,defaultMatchWidth:"wide",parsePatterns:Ue,defaultParseWidth:"wide"}),day:V({matchPatterns:et,defaultMatchWidth:"wide",parsePatterns:tt,defaultParseWidth:"wide"}),dayPeriod:V({matchPatterns:nt,defaultMatchWidth:"wide",parsePatterns:at,defaultParseWidth:"any"})},rt={code:"vi",formatDistance:Fe,formatLong:Se,formatRelative:He,localize:Ye,match:it,options:{weekStartsOn:1,firstWeekContainsDate:1}},ot=e=>({patientFullName:e.fullName.trim(),patientDob:e.dob?O(e.dob,"dd/MM/yyyy"):"",patientDobOnlyYear:e.dob?new Date(e.dob).getFullYear():"",patientAge:e.dob?`${st(e.dob)}`:"",patientDobAge:e.dob?ut(e.dob):"",patientAddress:e.address||"",patientGender:ct(e.gender||0),patientPhoneNumber:e.phone||"",patientCareer:e.career||"",yearOfTreatment:new Date().getFullYear(),todayDateFull:dt(new Date),todayDate:O(new Date,"dd/MM/yyyy")}),st=e=>{const n=new Date(e),t=new Date;let i=t.getFullYear()-n.getFullYear();return t.getMonth()>n.getMonth()||t.getMonth()===n.getMonth()&&t.getDate()>=n.getDate()||i--,i},ct=e=>Object.values(Me).find(t=>t.value===e)?.text,dt=(e,n="full",t=!1)=>{try{const i=new Date(e);return n==="short"?O(i,"dd/MM/yyyy"):O(i,t?"EEEE, 'ngày' dd 'tháng' MM 'năm' yyyy":"'Ngày' dd 'tháng' MM 'năm' yyyy",{locale:rt})}catch{return""}},ut=e=>{try{const n=new Date(e),t=O(n,"dd/MM/yyyy"),i=ke(new Date,n);return`${t} - ${i} tuổi`}catch{return console.error("Invalid date:",e),""}};var ce=(e=>(e.CHECKBOX_CHANGE="checkbox-change",e))(ce||{});function lt(e,n){setTimeout(()=>{try{const t=n.body.scrollHeight,i=n.body.scrollWidth;e.style.height=`${t}px`,e.style.width=`${i}px`,e.style.opacity="1"}catch(t){console.warn("Cannot resize iframe:",t)}},0)}function ht(e){const n=e.createElement("script");n.type="text/javascript",n.textContent=`
    document.addEventListener('change', function (e) {
      const checkbox = e.target;
      if (checkbox && checkbox.matches('input[type="checkbox"]')) {
        console.log('Checkbox changed:', checkbox.getAttribute('data-field'), checkbox.checked);
        window.parent.postMessage({
          pageId: checkbox.getAttribute('data-page-id'),
          type: 'checkbox-change',
          fieldName: checkbox.getAttribute('data-field'),
          checked: checkbox.checked,
        }, '*');
      }
    });
  `,e.body.appendChild(n)}const gt=()=>{const e=fe(),{systemConfig:n}=pe(),{selectedPatientCode:t,setDoneLoadingIframe:i,doneLoadingDocument:c,doneLoadingIframe:T}=ye(),h=se(),[w,v]=l.useState(null),[p,P]=l.useState(1),[D,q]=l.useState(!1),b=l.useRef(null),m=l.useRef(null),{data:Q}=be({documentId:e.documentId,patientCode:t}),{data:de}=Te({patientCode:t,documentId:e.documentId}),{data:j}=we({patientCode:t});l.useEffect(()=>{i(!1)},[]),l.useEffect(()=>{const o=L(b);if(o){if(m.current){const a=o.querySelector(`[data-field="${m.current}"][data-page-index="${p}"]`);if(a){a.classList.remove("bg-warning");const s=a.textContent?.trim().toLowerCase();if(!s||s===a.getAttribute("data-suggestion")){const r=a.getAttribute("data-default-value");r?a.textContent=r:a.textContent=""}}}if(w){const a=o.querySelector(`[data-field="${w}"][data-page-index="${p}"]`);if(a&&(a.classList.add("bg-warning"),!a.textContent?.trim())){const r=a.getAttribute("data-suggestion");r&&(a.textContent=r)}}m.current=w}},[w,m.current]);function ue(o){Array.from(o.querySelectorAll('input.custom-checkbox[type="checkbox"], input.custom-checkbox-small[type="checkbox"], input.custom-radio[type="radio"]')).forEach(s=>{const r=o.createElement("span");r.style.display="inline-block",r.style.width=(s.classList.contains("custom-checkbox-small")?15:20)+"px",r.style.height=(s.classList.contains("custom-checkbox-small")?15:20)+"px",r.style.border="1px solid #000",r.style.lineHeight=r.style.height,r.style.textAlign="center",r.style.verticalAlign="middle",r.style.fontSize=r.style.height,r.style.marginRight="2px",r.textContent=s.checked?"✓":"",s.after(r),s.style.display="none"})}const z=async(o,a)=>{let s=L(b);if(!s)return;const r=s.cloneNode(!0);ue(r);const f="<!doctype html><html>"+r.documentElement.innerHTML+"</html>";switch(a){case te[0].key:{electron.ipcRenderer.send(ne.PRINT_DOCUMENT,{htmlContent:f});break}case te[1].key:{const g=await electron.ipcRenderer.invoke("show-save-dialog",{title:"Save PDF file",defaultPath:"document.pdf",filters:[{name:"PDF Files",extensions:["pdf"]}]});if(!g)return;electron.ipcRenderer.send(ne.PRINT_TO_PDF,{filePath:g,htmlContent:f});break}}},X=o=>{const a=L(b);if(!a)return;const s=a.getElementById(`page_${o}`);s?s.scrollIntoView({behavior:"smooth"}):console.log("Element not found inside iframe")},K=xe((o,a,s)=>{const r=L(b);if(!r)return;const f=r.querySelector(`[data-field="${o}"][data-page-index="${p}"]`);if(f){const g=a||s;f.textContent=g}},333),G=o=>{!o||!o.pageIndex||!o.fieldName||(X(o.pageIndex),P(o.pageIndex),v(o.fieldName))};ve(o=>{if(!o)return;const a=o.data;switch(o.action){case M.PrintDocument:z(a.documentName,a.printType);break;case M.OnChangeDocumentPage:if(!a||!a.pageIndex)return;X(a.pageIndex),P(a.pageIndex);break;case M.OnChangeFieldEditorValueChange:K(a.fieldName,a.newFieldValue,a.defaultFieldValue);break;case M.OnFocusFieldEditor:G(a);break;case M.OnBlurFieldEditor:v(null);break}},[z,K,G,v,P]),l.useEffect(()=>{if(!Q||!b.current)return;const o=Ce[Q.data.documentType]?.toLowerCase();Promise.all([ie(n.base_static_host_dev),ae(n.base_static_host_dev,o)]).then(([a,s])=>{let r=a.replaceAll("{BASE_STATIC_HOST}",n.base_static_host_dev),f=s.replaceAll("{BASE_STATIC_HOST}",n.base_static_host_dev);const g=r.replace('<div class="content-container"></div>',`<div class="content-container">${f}</div>`),d=b.current;d.srcdoc=g,d.onload=()=>{const x=L(b);x&&(lt(d,x),ht(x),i(!0))}})},[ie,ae,Q?.data,j?.data]),l.useEffect(()=>{T&&c&&q(!0)},[T,c]);function le(o,a,s=5e3){return new Promise((r,f)=>{const g=o.contentWindow,d=g?.document;if(!g||!d)return f(new Error("No iframe window/document"));let x=null,C;const I=()=>{try{x?.disconnect()}catch{}C!==void 0&&clearTimeout(C),d.removeEventListener("readystatechange",F)},k=u=>{I(),r(u)},E=u=>{I(),f(u)},A=()=>Array.from(d.querySelectorAll(a)),S=()=>{const u=A();if(u.length)return k(u);x=new MutationObserver(()=>{const y=A();y.length&&k(y)}),x.observe(d.documentElement,{childList:!0,subtree:!0})},F=()=>{(d.readyState==="interactive"||d.readyState==="complete")&&(d.removeEventListener("readystatechange",F),S())},_=A();if(_.length)return k(_);d.readyState==="interactive"||d.readyState==="complete"?S():d.addEventListener("readystatechange",F),C=window.setTimeout(()=>{E(new Error(`Timeout waiting for '${a}' in iframe`))},s)})}return l.useEffect(()=>{if(!T||!c)return;const o=b.current;if(!o)return;let a=!1;return le(o,".a4-page",5e3).then(s=>{if(a)return;const r=o.contentWindow;r.document,(r.requestAnimationFrame||window.requestAnimationFrame)(()=>{const g=ot(j.data),d=JSON.parse(de.data),x=d?.sharedFields,C={sharedFields:{}},I={};for(const k of s){const E=k.id;C[E]={};const A=parseInt(k.getAttribute("data-page-index")||"-1",10),S=d?.[E],F=Array.from(k.querySelectorAll("[data-field]"));if(!F.length)continue;const _={};for(const u of F){const y=u.getAttribute("data-field"),Z=u.getAttribute("data-type")||"text",he=u.getAttribute("data-suggestion")||void 0,ge=u.getAttribute("data-caption")||void 0,$=u.getAttribute("data-shared")||void 0,J=u.getAttribute("data-field-ref")||void 0;let B;switch(Z){case ee.TEXT:{if($&&$===y){const R=g[y],H=x?.[$]||R||"";C.sharedFields[y]=H,u.textContent=H}else{const R=J?g[J]:"",H=S?.[y]||R||"";C[E][y]=H,u.textContent=H}break}case ee.CHECKBOX:{B=!!S?.[y],u.checked=B,C[E][y]=B;break}}_[y]={fieldType:Z,fieldCurrentValue:B,fieldSuggestion:he,fieldLabel:ge,fieldShared:$}}I[E]={parsedFields:_,pageNumber:A}}h({action:M.CreateEditDocumentFields,data:{parsedPages:I,defaultValues:C}})})}).catch(s=>{console.warn(s)}),()=>{a=!0}},[T,c]),l.useEffect(()=>{const o=a=>{const{pageId:s,type:r,fieldName:f,checked:g}=a.data||{};r===ce.CHECKBOX_CHANGE&&h({action:M.OnDocumentCheckboxChange,data:{pageId:s,fieldName:f,isChecked:g}})};return window.addEventListener("message",o),()=>window.removeEventListener("message",o)},[]),N.jsx("iframe",{title:"document detail",className:"overflow-hidden opacity-5 mt-12",ref:b,src:"about:blank"})},mt=()=>{const[e,n]=l.useState(1),[t,i]=l.useState(100),[c,T]=l.useState(20),h=se(),w=l.useRef(null),v=(P,D,q)=>{i(D)},p=(P,D)=>{n(D),h({action:M.OnChangeDocumentPage,data:{pageIndex:D}})};return N.jsx(Pe,{totalPages:c,pageIndex:e,onPageChange:p,zoomValue:t,onPageZoom:v,nodeRef:w,children:N.jsx(gt,{})})};export{pt as DocumentView};
