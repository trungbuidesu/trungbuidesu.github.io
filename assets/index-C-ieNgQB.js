import{j as I,b8 as U,b9 as oe,ba as Y,bb as W,bc as V,bd as ge,be as $,b4 as me,bf as fe,u as pe,az as se,r as h,bg as be,bh as ye,bi as Te,bj as we,bk as ve,aB as M,b7 as Ce,bl as ee,bm as te,bn as ne,bo as xe}from"./index-DGQyO2cc.js";const Pe={male:{text:"Nam",value:1},female:{text:"Nữ",value:2},other:{text:"Khác",value:3},notProvided:{text:"Không cung cấp",value:0}},ae=async(e,n)=>{try{const t=await fetch(`${e}/print_templates/${n}/pages.json?t=${Date.now()}`,{cache:"no-store"}).then(l=>l.json()),r=await Promise.all(t.map(l=>fetch(`${e}/print_templates/${n}/${l}?t=${Date.now()}`,{cache:"no-store"})));return(await Promise.all(r.map(l=>l.text()))).map(l=>{const m=new DOMParser().parseFromString(l,"text/html").querySelector(".a4-page"),P=m.getAttribute("data-page-index"),D=m.id;return m.querySelectorAll("[data-field]").forEach(g=>g.setAttribute("data-page-index",P)),Array.from(m.querySelectorAll('input[type="checkbox"]')).forEach(g=>{g.hasAttribute("data-type")||g.setAttribute("data-type","checkbox"),g.hasAttribute("data-page-index")||g.setAttribute("data-page-index",P),g.hasAttribute("data-page-id")||g.setAttribute("data-page-id",D)}),m.outerHTML}).join(`
`)}catch(t){return console.error("Error loading template content:",t),""}},re=async e=>await fetch(`${e}/print_templates/base.html`,{cache:"no-cache"}).then(t=>t.text()).catch(t=>(console.log(t),"")),ft=()=>I.jsx(I.Fragment,{children:I.jsx(gt,{})}),O=e=>{const n=e.current;if(!n)return null;const t=n.contentDocument||n.contentWindow?.document;return t||null};function ie(e,n){const t=+U(e)-+U(n);return t<0?-1:t>0?1:t}function Me(e,n,t){const[r,s]=oe(t?.in,e,n);return r.getFullYear()-s.getFullYear()}function De(e,n,t){const[r,s]=oe(t?.in,e,n),T=ie(r,s),l=Math.abs(Me(r,s));r.setFullYear(1584),s.setFullYear(1584);const w=ie(r,s)===-T,v=T*(l-+w);return v===0?0:v}const Fe={lessThanXSeconds:{one:"dưới 1 giây",other:"dưới {{count}} giây"},xSeconds:{one:"1 giây",other:"{{count}} giây"},halfAMinute:"nửa phút",lessThanXMinutes:{one:"dưới 1 phút",other:"dưới {{count}} phút"},xMinutes:{one:"1 phút",other:"{{count}} phút"},aboutXHours:{one:"khoảng 1 giờ",other:"khoảng {{count}} giờ"},xHours:{one:"1 giờ",other:"{{count}} giờ"},xDays:{one:"1 ngày",other:"{{count}} ngày"},aboutXWeeks:{one:"khoảng 1 tuần",other:"khoảng {{count}} tuần"},xWeeks:{one:"1 tuần",other:"{{count}} tuần"},aboutXMonths:{one:"khoảng 1 tháng",other:"khoảng {{count}} tháng"},xMonths:{one:"1 tháng",other:"{{count}} tháng"},aboutXYears:{one:"khoảng 1 năm",other:"khoảng {{count}} năm"},xYears:{one:"1 năm",other:"{{count}} năm"},overXYears:{one:"hơn 1 năm",other:"hơn {{count}} năm"},almostXYears:{one:"gần 1 năm",other:"gần {{count}} năm"}},Ne=(e,n,t)=>{let r;const s=Fe[e];return typeof s=="string"?r=s:n===1?r=s.one:r=s.other.replace("{{count}}",String(n)),t?.addSuffix?t.comparison&&t.comparison>0?r+" nữa":r+" trước":r},Ee={full:"EEEE, 'ngày' d MMMM 'năm' y",long:"'ngày' d MMMM 'năm' y",medium:"d MMM 'năm' y",short:"dd/MM/y"},Ie={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},ke={full:"{{date}} {{time}}",long:"{{date}} {{time}}",medium:"{{date}} {{time}}",short:"{{date}} {{time}}"},Ae={date:Y({formats:Ee,defaultWidth:"full"}),time:Y({formats:Ie,defaultWidth:"full"}),dateTime:Y({formats:ke,defaultWidth:"full"})},Se={lastWeek:"eeee 'tuần trước vào lúc' p",yesterday:"'hôm qua vào lúc' p",today:"'hôm nay vào lúc' p",tomorrow:"'ngày mai vào lúc' p",nextWeek:"eeee 'tới vào lúc' p",other:"P"},_e=(e,n,t,r)=>Se[e],He={narrow:["TCN","SCN"],abbreviated:["trước CN","sau CN"],wide:["trước Công Nguyên","sau Công Nguyên"]},We={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["Quý 1","Quý 2","Quý 3","Quý 4"]},Ve={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["quý I","quý II","quý III","quý IV"]},Oe={narrow:["1","2","3","4","5","6","7","8","9","10","11","12"],abbreviated:["Thg 1","Thg 2","Thg 3","Thg 4","Thg 5","Thg 6","Thg 7","Thg 8","Thg 9","Thg 10","Thg 11","Thg 12"],wide:["Tháng Một","Tháng Hai","Tháng Ba","Tháng Tư","Tháng Năm","Tháng Sáu","Tháng Bảy","Tháng Tám","Tháng Chín","Tháng Mười","Tháng Mười Một","Tháng Mười Hai"]},$e={narrow:["01","02","03","04","05","06","07","08","09","10","11","12"],abbreviated:["thg 1","thg 2","thg 3","thg 4","thg 5","thg 6","thg 7","thg 8","thg 9","thg 10","thg 11","thg 12"],wide:["tháng 01","tháng 02","tháng 03","tháng 04","tháng 05","tháng 06","tháng 07","tháng 08","tháng 09","tháng 10","tháng 11","tháng 12"]},Le={narrow:["CN","T2","T3","T4","T5","T6","T7"],short:["CN","Th 2","Th 3","Th 4","Th 5","Th 6","Th 7"],abbreviated:["CN","Thứ 2","Thứ 3","Thứ 4","Thứ 5","Thứ 6","Thứ 7"],wide:["Chủ Nhật","Thứ Hai","Thứ Ba","Thứ Tư","Thứ Năm","Thứ Sáu","Thứ Bảy"]},Be={narrow:{am:"am",pm:"pm",midnight:"nửa đêm",noon:"tr",morning:"sg",afternoon:"ch",evening:"tối",night:"đêm"},abbreviated:{am:"AM",pm:"PM",midnight:"nửa đêm",noon:"trưa",morning:"sáng",afternoon:"chiều",evening:"tối",night:"đêm"},wide:{am:"SA",pm:"CH",midnight:"nửa đêm",noon:"trưa",morning:"sáng",afternoon:"chiều",evening:"tối",night:"đêm"}},qe={narrow:{am:"am",pm:"pm",midnight:"nửa đêm",noon:"tr",morning:"sg",afternoon:"ch",evening:"tối",night:"đêm"},abbreviated:{am:"AM",pm:"PM",midnight:"nửa đêm",noon:"trưa",morning:"sáng",afternoon:"chiều",evening:"tối",night:"đêm"},wide:{am:"SA",pm:"CH",midnight:"nửa đêm",noon:"giữa trưa",morning:"vào buổi sáng",afternoon:"vào buổi chiều",evening:"vào buổi tối",night:"vào ban đêm"}},Qe=(e,n)=>{const t=Number(e),r=n?.unit;if(r==="quarter")switch(t){case 1:return"I";case 2:return"II";case 3:return"III";case 4:return"IV"}else if(r==="day")switch(t){case 1:return"thứ 2";case 2:return"thứ 3";case 3:return"thứ 4";case 4:return"thứ 5";case 5:return"thứ 6";case 6:return"thứ 7";case 7:return"chủ nhật"}else{if(r==="week")return t===1?"thứ nhất":"thứ "+t;if(r==="dayOfYear")return t===1?"đầu tiên":"thứ "+t}return String(t)},Re={ordinalNumber:Qe,era:W({values:He,defaultWidth:"wide"}),quarter:W({values:We,defaultWidth:"wide",formattingValues:Ve,defaultFormattingWidth:"wide",argumentCallback:e=>e-1}),month:W({values:Oe,defaultWidth:"wide",formattingValues:$e,defaultFormattingWidth:"wide"}),day:W({values:Le,defaultWidth:"wide"}),dayPeriod:W({values:Be,defaultWidth:"wide",formattingValues:qe,defaultFormattingWidth:"wide"})},Ye=/^(\d+)/i,je=/\d+/i,ze={narrow:/^(tcn|scn)/i,abbreviated:/^(trước CN|sau CN)/i,wide:/^(trước Công Nguyên|sau Công Nguyên)/i},Xe={any:[/^t/i,/^s/i]},Ke={narrow:/^([1234]|i{1,3}v?)/i,abbreviated:/^q([1234]|i{1,3}v?)/i,wide:/^quý ([1234]|i{1,3}v?)/i},Ge={any:[/(1|i)$/i,/(2|ii)$/i,/(3|iii)$/i,/(4|iv)$/i]},Ze={narrow:/^(0?[2-9]|10|11|12|0?1)/i,abbreviated:/^thg[ _]?(0?[1-9](?!\d)|10|11|12)/i,wide:/^tháng ?(Một|Hai|Ba|Tư|Năm|Sáu|Bảy|Tám|Chín|Mười|Mười ?Một|Mười ?Hai|0?[1-9](?!\d)|10|11|12)/i},Je={narrow:[/0?1$/i,/0?2/i,/3/,/4/,/5/,/6/,/7/,/8/,/9/,/10/,/11/,/12/],abbreviated:[/^thg[ _]?0?1(?!\d)/i,/^thg[ _]?0?2/i,/^thg[ _]?0?3/i,/^thg[ _]?0?4/i,/^thg[ _]?0?5/i,/^thg[ _]?0?6/i,/^thg[ _]?0?7/i,/^thg[ _]?0?8/i,/^thg[ _]?0?9/i,/^thg[ _]?10/i,/^thg[ _]?11/i,/^thg[ _]?12/i],wide:[/^tháng ?(Một|0?1(?!\d))/i,/^tháng ?(Hai|0?2)/i,/^tháng ?(Ba|0?3)/i,/^tháng ?(Tư|0?4)/i,/^tháng ?(Năm|0?5)/i,/^tháng ?(Sáu|0?6)/i,/^tháng ?(Bảy|0?7)/i,/^tháng ?(Tám|0?8)/i,/^tháng ?(Chín|0?9)/i,/^tháng ?(Mười|10)/i,/^tháng ?(Mười ?Một|11)/i,/^tháng ?(Mười ?Hai|12)/i]},Ue={narrow:/^(CN|T2|T3|T4|T5|T6|T7)/i,short:/^(CN|Th ?2|Th ?3|Th ?4|Th ?5|Th ?6|Th ?7)/i,abbreviated:/^(CN|Th ?2|Th ?3|Th ?4|Th ?5|Th ?6|Th ?7)/i,wide:/^(Chủ ?Nhật|Chúa ?Nhật|thứ ?Hai|thứ ?Ba|thứ ?Tư|thứ ?Năm|thứ ?Sáu|thứ ?Bảy)/i},et={narrow:[/CN/i,/2/i,/3/i,/4/i,/5/i,/6/i,/7/i],short:[/CN/i,/2/i,/3/i,/4/i,/5/i,/6/i,/7/i],abbreviated:[/CN/i,/2/i,/3/i,/4/i,/5/i,/6/i,/7/i],wide:[/(Chủ|Chúa) ?Nhật/i,/Hai/i,/Ba/i,/Tư/i,/Năm/i,/Sáu/i,/Bảy/i]},tt={narrow:/^(a|p|nửa đêm|trưa|(giờ) (sáng|chiều|tối|đêm))/i,abbreviated:/^(am|pm|nửa đêm|trưa|(giờ) (sáng|chiều|tối|đêm))/i,wide:/^(ch[^i]*|sa|nửa đêm|trưa|(giờ) (sáng|chiều|tối|đêm))/i},nt={any:{am:/^(a|sa)/i,pm:/^(p|ch[^i]*)/i,midnight:/nửa đêm/i,noon:/trưa/i,morning:/sáng/i,afternoon:/chiều/i,evening:/tối/i,night:/^đêm/i}},at={ordinalNumber:ge({matchPattern:Ye,parsePattern:je,valueCallback:e=>parseInt(e,10)}),era:V({matchPatterns:ze,defaultMatchWidth:"wide",parsePatterns:Xe,defaultParseWidth:"any"}),quarter:V({matchPatterns:Ke,defaultMatchWidth:"wide",parsePatterns:Ge,defaultParseWidth:"any",valueCallback:e=>e+1}),month:V({matchPatterns:Ze,defaultMatchWidth:"wide",parsePatterns:Je,defaultParseWidth:"wide"}),day:V({matchPatterns:Ue,defaultMatchWidth:"wide",parsePatterns:et,defaultParseWidth:"wide"}),dayPeriod:V({matchPatterns:tt,defaultMatchWidth:"wide",parsePatterns:nt,defaultParseWidth:"any"})},rt={code:"vi",formatDistance:Ne,formatLong:Ae,formatRelative:_e,localize:Re,match:at,options:{weekStartsOn:1,firstWeekContainsDate:1}},it=e=>({patientFullName:e.fullName.trim(),patientDob:e.dob?$(e.dob,"dd/MM/yyyy"):"",patientDobOnlyYear:e.dob?new Date(e.dob).getFullYear():"",patientAge:e.dob?`${ot(e.dob)}`:"",patientDobAge:e.dob?dt(e.dob):"",patientAddress:e.address||"",patientGender:st(e.gender||0),patientPhoneNumber:e.phone||"",patientCareer:e.career||"",yearOfTreatment:new Date().getFullYear(),todayDateFull:ct(new Date),todayDate:$(new Date,"dd/MM/yyyy")}),ot=e=>{const n=new Date(e),t=new Date;let r=t.getFullYear()-n.getFullYear();return t.getMonth()>n.getMonth()||t.getMonth()===n.getMonth()&&t.getDate()>=n.getDate()||r--,r},st=e=>Object.values(Pe).find(t=>t.value===e)?.text,ct=(e,n="full",t=!1)=>{try{const r=new Date(e);return n==="short"?$(r,"dd/MM/yyyy"):$(r,t?"EEEE, 'ngày' dd 'tháng' MM 'năm' yyyy":"'Ngày' dd 'tháng' MM 'năm' yyyy",{locale:rt})}catch{return""}},dt=e=>{try{const n=new Date(e),t=$(n,"dd/MM/yyyy"),r=De(new Date,n);return`${t} - ${r} tuổi`}catch{return console.error("Invalid date:",e),""}};var ce=(e=>(e.CHECKBOX_CHANGE="checkbox-change",e))(ce||{});function ut(e,n){setTimeout(()=>{try{const t=n.body.scrollHeight,r=n.body.scrollWidth;e.style.height=`${t}px`,e.style.width=`${r}px`,e.style.opacity="1"}catch(t){console.warn("Cannot resize iframe:",t)}},0)}function ht(e){const n=e.createElement("script");n.type="text/javascript",n.textContent=`
    document.addEventListener('change', function (e) {
      const checkbox = e.target;
      if (checkbox && checkbox.matches('input[type="checkbox"]')) {
        console.log('Checkbox changed:', checkbox.getAttribute('data-field'), checkbox.checked);
        window.parent.postMessage({
          pageId: checkbox.getAttribute('data-page-id'),
          type: 'checkbox-change',
          fieldName: checkbox.getAttribute('data-field'),
          checked: checkbox.checked,
        }, '*');
      }
    });
  `,e.body.appendChild(n)}const lt=()=>{const e=me(),{systemConfig:n}=fe(),{selectedPatientCode:t,setDoneLoadingIframe:r,doneLoadingDocument:s,doneLoadingIframe:T}=pe(),l=se(),[w,v]=h.useState(null),[m,P]=h.useState(1),[D,q]=h.useState(!1),b=h.useRef(null),g=h.useRef(null),{data:Q}=be({documentId:e.documentId,patientCode:t}),{data:de}=ye({patientCode:t,documentId:e.documentId}),{data:j}=Te({patientCode:t});h.useEffect(()=>{r(!1)},[]),h.useEffect(()=>{const i=O(b);if(i){if(g.current){const a=i.querySelector(`[data-field="${g.current}"][data-page-index="${m}"]`);if(a){a.classList.remove("bg-warning");const o=a.textContent?.trim().toLowerCase();if(!o||o===a.getAttribute("data-suggestion")){const c=a.getAttribute("data-default-value");c?a.textContent=c:a.textContent=""}}}if(w){const a=i.querySelector(`[data-field="${w}"][data-page-index="${m}"]`);if(a&&(a.classList.add("bg-warning"),!a.textContent?.trim())){const c=a.getAttribute("data-suggestion");c&&(a.textContent=c)}}g.current=w}},[w,g.current]);const z=async(i,a)=>{let o=O(b);if(o)switch(a){case te[0].key:{electron.ipcRenderer.send(ne.PRINT_DOCUMENT,{htmlContent:o.body.innerHTML});break}case te[1].key:{const c=await electron.ipcRenderer.invoke("show-save-dialog",{title:"Save PDF file",defaultPath:"document.pdf",filters:[{name:"PDF Files",extensions:["pdf"]}]});if(!c)return;electron.ipcRenderer.send(ne.PRINT_TO_PDF,{filePath:c,htmlContent:o.body.innerHTML});break}}},X=i=>{const a=O(b);if(!a)return;const o=a.getElementById(`page_${i}`);o?o.scrollIntoView({behavior:"smooth"}):console.log("Element not found inside iframe")},K=ve((i,a,o)=>{const c=O(b);if(!c)return;const y=c.querySelector(`[data-field="${i}"][data-page-index="${m}"]`);if(y){const f=a||o;y.textContent=f}},333),G=i=>{!i||!i.pageIndex||!i.fieldName||(X(i.pageIndex),P(i.pageIndex),v(i.fieldName))};we(i=>{if(!i)return;const a=i.data;switch(i.action){case M.PrintDocument:z(a.documentName,a.printType);break;case M.OnChangeDocumentPage:if(!a||!a.pageIndex)return;X(a.pageIndex),P(a.pageIndex);break;case M.OnChangeFieldEditorValueChange:K(a.fieldName,a.newFieldValue,a.defaultFieldValue);break;case M.OnFocusFieldEditor:G(a);break;case M.OnBlurFieldEditor:v(null);break}},[z,K,G,v,P]),h.useEffect(()=>{if(!Q||!b.current)return;const i=Ce[Q.data.documentType]?.toLowerCase();Promise.all([re(n.base_static_host),ae(n.base_static_host,i)]).then(([a,o])=>{let c=a.replaceAll("{BASE_STATIC_HOST}",n.base_static_host),y=o.replaceAll("{BASE_STATIC_HOST}",n.base_static_host);const f=c.replace('<div class="content-container"></div>',`<div class="content-container">${y}</div>`),d=b.current;d.srcdoc=f,d.onload=()=>{const C=O(b);C&&(ut(d,C),ht(C),r(!0))}})},[re,ae,Q?.data,j?.data]),h.useEffect(()=>{T&&s&&q(!0)},[T,s]);function ue(i,a,o=5e3){return new Promise((c,y)=>{const f=i.contentWindow,d=f?.document;if(!f||!d)return y(new Error("No iframe window/document"));let C=null,x;const k=()=>{try{C?.disconnect()}catch{}x!==void 0&&clearTimeout(x),d.removeEventListener("readystatechange",E)},F=u=>{k(),c(u)},N=u=>{k(),y(u)},A=()=>Array.from(d.querySelectorAll(a)),S=()=>{const u=A();if(u.length)return F(u);C=new MutationObserver(()=>{const p=A();p.length&&F(p)}),C.observe(d.documentElement,{childList:!0,subtree:!0})},E=()=>{(d.readyState==="interactive"||d.readyState==="complete")&&(d.removeEventListener("readystatechange",E),S())},_=A();if(_.length)return F(_);d.readyState==="interactive"||d.readyState==="complete"?S():d.addEventListener("readystatechange",E),x=window.setTimeout(()=>{N(new Error(`Timeout waiting for '${a}' in iframe`))},o)})}return h.useEffect(()=>{if(!T||!s)return;const i=b.current;if(!i)return;let a=!1;return ue(i,".a4-page",5e3).then(o=>{if(a)return;const c=i.contentWindow;c.document,(c.requestAnimationFrame||window.requestAnimationFrame)(()=>{const f=it(j.data),d=JSON.parse(de.data),C=d?.sharedFields,x={sharedFields:{}},k={};for(const F of o){const N=F.id;x[N]={};const A=parseInt(F.getAttribute("data-page-index")||"-1",10),S=d?.[N],E=Array.from(F.querySelectorAll("[data-field]"));if(!E.length)continue;const _={};for(const u of E){const p=u.getAttribute("data-field"),Z=u.getAttribute("data-type")||"text",he=u.getAttribute("data-suggestion")||void 0,le=u.getAttribute("data-caption")||void 0,L=u.getAttribute("data-shared")||void 0,J=u.getAttribute("data-field-ref")||void 0;let B;switch(Z){case ee.TEXT:{if(L&&L===p){const R=f[p],H=C?.[L]||R||"";x.sharedFields[p]=H,u.textContent=H}else{const R=J?f[J]:"",H=S?.[p]||R||"";x[N][p]=H,u.textContent=H}break}case ee.CHECKBOX:{B=!!S?.[p],u.checked=B,x[N][p]=B;break}}_[p]={fieldType:Z,fieldCurrentValue:B,fieldSuggestion:he,fieldLabel:le,fieldShared:L}}k[N]={parsedFields:_,pageNumber:A}}l({action:M.CreateEditDocumentFields,data:{parsedPages:k,defaultValues:x}})})}).catch(o=>{console.warn(o)}),()=>{a=!0}},[T,s]),h.useEffect(()=>{const i=a=>{const{pageId:o,type:c,fieldName:y,checked:f}=a.data||{};c===ce.CHECKBOX_CHANGE&&l({action:M.OnDocumentCheckboxChange,data:{pageId:o,fieldName:y,isChecked:f}})};return window.addEventListener("message",i),()=>window.removeEventListener("message",i)},[]),I.jsx("iframe",{title:"document detail",className:"overflow-hidden opacity-5 mt-12",ref:b,src:"about:blank"})},gt=()=>{const[e,n]=h.useState(1),[t,r]=h.useState(100),[s,T]=h.useState(20),l=se(),w=h.useRef(null),v=(P,D,q)=>{r(D)},m=(P,D)=>{n(D),l({action:M.OnChangeDocumentPage,data:{pageIndex:D}})};return I.jsx(xe,{totalPages:s,pageIndex:e,onPageChange:m,zoomValue:t,onPageZoom:v,nodeRef:w,children:I.jsx(lt,{})})};export{ft as DocumentView};
